{% extends 'users/base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{% trans "–õ–æ–≥—ñ–Ω" %}{% endblock %}
{% block content %}
<h1 class="auth-title">{% trans "–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É" %}</h1>
<p class="subtitle">{% trans "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –≤–∞—à—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ" %}</p>

<div id="message"></div>

<form id="loginForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="email">{% trans "Email" %} *</label>
        <input type="email" id="email" name="email" required>
    </div>

    <div class="form-group">
        <label for="password">{% trans "–ü–∞—Ä–æ–ª—å" %}</label>
        <input type="password" id="password" name="password" required autocomplete="current-password">
    </div>

    <button class="btn-auth" type="submit" id="submitBtn">{% trans "–£–≤—ñ–π—Ç–∏" %}</button>
    <div class="loading" id="loading">{% trans "–í—Ö—ñ–¥..." %}</div>
</form>

<div class="register-link">
    {% trans "–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞?" %} <a style="display: inline-block;" href="{% url 'accounts:register_page' %}">{% trans "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è" %}</a>
    {% get_current_language as LANGUAGE_CODE %}
    <div style="display: flex; align-items: center; gap: 8px; justify-content: center; margin-top: 10px;">
        <span class="language-flag" style="font-size: 24px;">
            {% if LANGUAGE_CODE == 'uk' %}üá∫üá¶{% else %}üáµüá±{% endif %}
        </span>
        <form class="language-switcher__form auth-form" action="{% url 'set_language' %}" method="post">
            {% csrf_token %}
            <input name="next" type="hidden" value="{{ request.path }}">
            <select name="language" class="language-switcher__select" onchange="this.form.submit()">
                <option value="uk" {% if LANGUAGE_CODE == 'uk' %}selected{% endif %}>{% trans "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞" %}</option>
                <option value="pl" {% if LANGUAGE_CODE == 'pl' %}selected{% endif %}>{% trans "Polski" %}</option>
            </select>
        </form>
    </div>
</div>
<script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            submitBtn.disabled = true;
            loading.style.display = 'block';
            messageDiv.innerHTML = '';

            try {
                const response = await fetch('/api/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = `<div class="success">${data.message}</div>`;

                    setTimeout(() => {
                        window.location.href = "{% url 'main:dashboard' %}";
                    }, 500);
                } else {
                    // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É
                    messageDiv.innerHTML = `<div class="error">${data.error || '{% filter escapejs %}{% trans "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É" %}{% endfilter %}'}</div>`;
                    submitBtn.disabled = false;
                    loading.style.display = 'none';
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">{% filter escapejs %}{% trans "–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É." %}{% endfilter %}</div>';
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        });
    </script>
{% endblock %}
